name: Update Pluto app from registry

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Channel to update (stable or beta)"
        required: true
        default: "stable"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Log in to GitHub Container Registry
        if: ${{ secrets.GHCR_TOKEN != '' }}
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Pluto app manifests
        id: update
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/update-pluto-from-registry.sh
          # Run with --no-commit so we can handle git operations in the workflow
          # Exit code 2 means no changes needed, which is fine
          set +e
          scripts/update-pluto-from-registry.sh \
            --channel "${{ github.event.inputs.channel }}" \
            --no-commit
          exit_code=$?
          set -e
          if [[ $exit_code -eq 2 ]]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "No changes needed - bundle unchanged."
          elif [[ $exit_code -ne 0 ]]; then
            echo "Script failed with exit code $exit_code"
            exit $exit_code
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract new app version
        id: version
        if: steps.update.outputs.no_changes != 'true'
        run: |
          # Determine which app directory was updated
          if [[ "${{ github.event.inputs.channel }}" == "stable" ]]; then
            APP_DIR="pluto-mining-pluto"
          else
            APP_DIR="pluto-mining-pluto-next"
          fi
          # Extract version from umbrel-app.yml
          NEW_VERSION=$(grep -E '^version:' "${APP_DIR}/umbrel-app.yml" | sed -E 's/version: "(.*)"/\1/')
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New app version: ${NEW_VERSION}"

      - name: Commit and push changes
        if: steps.update.outputs.no_changes != 'true'
        run: |
          # Determine which app directory was updated
          if [[ "${{ github.event.inputs.channel }}" == "stable" ]]; then
            APP_DIR="pluto-mining-pluto"
          else
            APP_DIR="pluto-mining-pluto-next"
          fi
          git add "${APP_DIR}/umbrel-app.yml" "${APP_DIR}/docker-compose.yml"
          git commit -m "Update Pluto (${{ github.event.inputs.channel }}) to app version ${{ steps.version.outputs.new_version }}" -m "Re-resolved image digests from registry"
          git push

